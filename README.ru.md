# NixOS-AutoInfect

Скрипт для установки **NixOS** на не-NixOS хосты.

Этот форк сосредоточен на максимальной совместимости с распространенными дистрибутивами Linux (Debian, Ubuntu, CentOS и т.д.) и поддерживает специфичные облачные/виртуальные платформы:

- AWS EC2/Lightsail
- Azure
- Google Compute Engine (GCE)
- OpenStack
- Docker
- LXC
- QEMU
- VMware
- VirtualBox
- Xen

Если вы используете другую платформу, скрипт будет использовать логику по умолчанию, подходящую для большинства физических и виртуальных серверов.

---

## Что это?

NixOS-AutoInfect — это скрипт для установки NixOS на хосты, не являющиеся NixOS. Он разработан для обеспечения максимальной совместимости с распространенными дистрибутивами Linux (Debian, Ubuntu, CentOS и т.д.) и различными облачными/виртуальными платформами.

**Внимание**: Этот скрипт может сделать систему неработоспособной. Используйте с особой осторожностью и предпочтительно только на свежеразвернутых системах.

---

## Использование

1. **Прочтите и поймите [скрипт](nixos-autoinfect)**, так как он **уничтожает** вашу существующую корневую файловую систему.
2. Разверните свежий VPS, выделенный сервер или облачную ВМ с не-Nix дистрибутивом (Debian, Ubuntu, CentOS и т.д.).
3. После установки NixOS будет разрешён вход по паролю для root по SSH (пароль выводится скриптом перед перезагрузкой). Для большей безопасности рекомендуется также добавить SSH-ключ для root и/или отключить вход по паролю после первого входа.
4. Запустите что-то вроде:

    ```bash
    curl https://raw.githubusercontent.com/fnltochka/nixos-autoinfect/main/nixos-autoinfect \
      | NIX_CHANNEL=nixos-25.05 NIXOS_STATE_VERSION=25.05 bash -x
    ```

    Вы можете указать другой `NIX_CHANNEL`, например, `nixos-25.05`.
    Также можно задать `NIXOS_STATE_VERSION` для управления версией `system.stateVersion` в конфиге (по умолчанию `25.05`).
    Подробнее: [документация system.stateVersion](https://search.nixos.org/options?channel=unstable&show=system.stateVersion&from=0&size=50&sort=relevance&type=packages&query=system.stateVersion)

По завершении процесса ваша система перезагрузится в NixOS.  
Скрипт выведет случайно сгенерированный **пароль root** перед перезагрузкой, если он не был установлен ранее.  
**Помните** о необходимости надежно сохранить его или немедленно изменить.

**Важно:** После установки разрешён вход по паролю для root по SSH (`PermitRootLogin yes`, `PasswordAuthentication true`).
В целях безопасности настоятельно рекомендуется сменить пароль root и/или отключить вход по паролю после первого входа.

---

## Поддерживаемые платформы

Этот скрипт пытается **автоматически определить** облачную/виртуальную платформу. Если конкретная платформа обнаружена, NixOS будет сконфигурирована с соответствующими модулями. Если автоопределение не удалось, скрипт вернется к **общей (generic)** конфигурации, подходящей для большинства сред.

Вы можете **явно указать** провайдера, используя переменную окружения `PROVIDER`, например: `PROVIDER=aws`.

**В настоящее время распознаваемые провайдеры для автоопределения (и явного указания):**

- `aws` (для AWS EC2/Lightsail)
- `azure`
- `gce` (Google Compute Engine)
- `openstack`
- `docker`
- `lxc`
- `qemu` (для гостей KVM/QEMU)
- `vmware`
- `virtualbox`
- `xen` (для Xen DomU)
- `hetznercloud` (через проверку специфичного файла)
- `generic` (запасной вариант для нераспознанных платформ или при явном указании для общего подхода)

---

## Проверенные платформы

Скрипт был протестирован на:

- Ubuntu 24.04 LTS
- Debian 12 (Bookworm)

Если вы используете другую платформу, скрипт будет использовать логику по умолчанию, подходящую для большинства физических и виртуальных серверов.

---

## Отказ от ответственности

Используйте на свой страх и риск!  
Этот скрипт удаляет и заменяет вашу ОС на NixOS. Убедитесь, что у вас есть резервные копии или что ваш сервер легко переразвертывается.

Если вы столкнетесь с проблемами, пожалуйста, откройте issue или pull request в репозитории этого форка:  
[https://github.com/fnltochka/nixos-autoinfect](https://github.com/fnltochka/nixos-autoinfect).

---

**Благодарность оригинальным авторам [`nixos-infect`](https://github.com/elitak/nixos-infect)** и всем участникам.  
Этот форк стремится предоставить лишь несколько доработок, сохраняя совместимость с оригинальным подходом.
